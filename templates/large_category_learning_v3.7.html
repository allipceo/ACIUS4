<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACIU S4 v3.7 - 대분류 학습</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 헤더 -->
        <div class="flex justify-between items-center mb-8">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">🎯 대분류 학습</h1>
                <p class="text-gray-600">카테고리별 학습을 통해 체계적으로 준비하세요</p>
            </div>
            <button onclick="goToHome()" 
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg 
                           transition-all duration-200 transform hover:scale-105 
                           focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 shadow-lg">
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                홈으로
            </button>
        </div>


        
        <!-- 카테고리 선택 -->
        <div class="max-w-4xl mx-auto mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">📚 카테고리 선택</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- 재산보험 -->
                <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <div class="text-center">
                        <div class="text-4xl mb-4">🏢</div>
                        <h4 class="text-lg font-bold text-blue-800 mb-2">재산보험</h4>
                        <p class="text-gray-600 mb-4">일반재산보험</p>
                        <div class="text-sm text-gray-500 mb-4">
                            <div>총 문제: <span class="font-medium">169문제</span></div>
                            <div>진도: <span id="progress-06재산보험">0%</span></div>
                            <div>정답률: <span id="accuracy-06재산보험">0%</span></div>
                        </div>
                        <button onclick="startCategoryLearning('06재산보험')" 
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            학습 시작
                        </button>
                    </div>
                </div>
                
                <!-- 특종보험 -->
                <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <div class="text-center">
                        <div class="text-4xl mb-4">🚗</div>
                        <h4 class="text-lg font-bold text-green-800 mb-2">특종보험</h4>
                        <p class="text-gray-600 mb-4">자동차보험</p>
                        <div class="text-sm text-gray-500 mb-4">
                            <div>총 문제: <span class="font-medium">182문제</span></div>
                            <div>진도: <span id="progress-07특종보험">0%</span></div>
                            <div>정답률: <span id="accuracy-07특종보험">0%</span></div>
                        </div>
                        <button onclick="startCategoryLearning('07특종보험')" 
                                class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                            학습 시작
                        </button>
                    </div>
                </div>
                
                <!-- 배상책임보험 -->
                <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <div class="text-center">
                        <div class="text-4xl mb-4">⚖️</div>
                        <h4 class="text-lg font-bold text-yellow-800 mb-2">배상책임보험</h4>
                        <p class="text-gray-600 mb-4">책임보험</p>
                        <div class="text-sm text-gray-500 mb-4">
                            <div>총 문제: <span class="font-medium">268문제</span></div>
                            <div>진도: <span id="progress-08배상책임보험">0%</span></div>
                            <div>정답률: <span id="accuracy-08배상책임보험">0%</span></div>
                        </div>
                        <button onclick="startCategoryLearning('08배상책임보험')" 
                                class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-colors">
                            학습 시작
                        </button>
                    </div>
                </div>
                
                <!-- 해상보험 -->
                <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <div class="text-center">
                        <div class="text-4xl mb-4">🚢</div>
                        <h4 class="text-lg font-bold text-purple-800 mb-2">해상보험</h4>
                        <p class="text-gray-600 mb-4">해상보험</p>
                        <div class="text-sm text-gray-500 mb-4">
                            <div>총 문제: <span class="font-medium">170문제</span></div>
                            <div>진도: <span id="progress-09해상보험">0%</span></div>
                            <div>정답률: <span id="accuracy-09해상보험">0%</span></div>
                        </div>
                        <button onclick="startCategoryLearning('09해상보험')" 
                                class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                            학습 시작
                        </button>
                    </div>
                </div>
            </div>
        </div>



        <!-- 액션 버튼들 -->
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">🚀 액션</h3>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button onclick="resetCategoryProgress()" 
                        class="flex-1 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white px-6 py-3 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg">
                    <span class="text-lg">📊</span>
                    <span class="ml-2 font-semibold">카테고리 진도 초기화</span>
                </button>
                <button onclick="goToHome()" 
                   class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-6 py-3 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg text-center">
                    <span class="text-lg">🏠</span>
                    <span class="ml-2 font-semibold">홈으로 돌아가기</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 중앙 데이터 관리 시스템 -->
    <script src="/static/js/central_data_manager.js"></script>
    <script src="/static/js/compatibility_layer.js"></script>
    <script src="/static/js/quiz_data_collector.js"></script>
    <script src="/static/js/realtime_sync_manager.js"></script>
    
    <script>
        // 홈으로 가기 함수
        function goToHome() {
            // 현재 창에서 홈으로 이동 (새 창 열림 방지)
            try {
                // 방법 1: replace 사용 (브라우저 히스토리에서 현재 페이지 제거)
                window.location.replace('/');
            } catch (error) {
                // 방법 2: assign 사용 (대체 방법)
                window.location.assign('/');
            }
        }
        
        // 페이지 로드 시 통계 표시
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== 대분류 학습 페이지 v3.7 로드 ===');
            
            // 중앙 데이터 관리 시스템 초기화 확인
            initializeCentralDataSystem();
            

        });

        // 중앙 데이터 관리 시스템 초기화
        function initializeCentralDataSystem() {
            console.log('=== 중앙 데이터 관리 시스템 초기화 ===');
            
            // 중앙 데이터 관리자 확인
            if (window.CentralDataManager) {
                console.log('✅ CentralDataManager 확인됨');
            } else {
                console.warn('⚠️ CentralDataManager를 찾을 수 없습니다.');
            }
            
            // 호환성 레이어 확인
            if (window.CompatibilityLayer) {
                console.log('✅ CompatibilityLayer 확인됨');
            } else {
                console.warn('⚠️ CompatibilityLayer를 찾을 수 없습니다.');
            }
            
            // 문제 풀이 데이터 수집기 확인
            if (window.QuizDataCollector) {
                console.log('✅ QuizDataCollector 확인됨');
            } else {
                console.warn('⚠️ QuizDataCollector를 찾을 수 없습니다.');
            }
            
            // 실시간 동기화 매니저 확인
            if (window.RealtimeSyncManager) {
                console.log('✅ RealtimeSyncManager 확인됨');
            } else {
                console.warn('⚠️ RealtimeSyncManager를 찾을 수 없습니다.');
            }
            
            console.log('✅ 중앙 데이터 관리 시스템 초기화 완료');
        }



        // 카테고리별 학습 시작
        function startCategoryLearning(category) {
            try {
                console.log(`=== ${category} 카테고리 학습 시작 ===`);
                
                // 카테고리 학습 시작 이벤트 발생
                triggerCategoryLearningStartEvent(category);
                
                // 현재 카테고리 정보 저장
                localStorage.setItem('aicu_current_category', category);
                
                // 카테고리별 진행상황 초기화 (없는 경우)
                const progressData = localStorage.getItem('aicu_category_progress') || '{}';
                const progress = JSON.parse(progressData);
                
                if (!progress[category]) {
                    progress[category] = {
                        currentQuestionIndex: 0,
                        lastUpdated: new Date().toISOString()
                    };
                    localStorage.setItem('aicu_category_progress', JSON.stringify(progress));
                }
                
                // 기본학습 페이지로 이동 (카테고리 모드)
                window.location.href = `/basic-learning?category=${category}`;
                
            } catch (error) {
                console.error(`❌ ${category} 카테고리 학습 시작 실패:`, error);
                alert('학습을 시작하는데 실패했습니다.');
            }
        }

        // 실시간 통계 업데이트 함수
        function updateStatistics(isCorrect) {
            try {
                console.log('=== 실시간 통계 업데이트 시작 ===');
                
                const currentCategory = localStorage.getItem('aicu_current_category') || '06재산보험';
                const statsData = localStorage.getItem('aicu_statistics') || '{}';
                const stats = JSON.parse(statsData);
                
                // 카테고리별 통계 초기화 (없는 경우)
                if (!stats.categories) {
                    stats.categories = {};
                }
                if (!stats.categories[currentCategory]) {
                    stats.categories[currentCategory] = {
                        solved: 0,
                        correct: 0,
                        accuracy: 0,
                        current_question_index: 0,
                        daily_progress: {}
                    };
                }
                
                // 통계 업데이트
                stats.categories[currentCategory].solved++;
                if (isCorrect) {
                    stats.categories[currentCategory].correct++;
                }
                stats.categories[currentCategory].accuracy = 
                    (stats.categories[currentCategory].correct / stats.categories[currentCategory].solved * 100).toFixed(1);
                
                // 일일 진행률 업데이트
                const today = new Date().toISOString().split('T')[0];
                if (!stats.categories[currentCategory].daily_progress[today]) {
                    stats.categories[currentCategory].daily_progress[today] = {
                        solved: 0,
                        correct: 0
                    };
                }
                stats.categories[currentCategory].daily_progress[today].solved++;
                if (isCorrect) {
                    stats.categories[currentCategory].daily_progress[today].correct++;
                }
                
                // 누적 통계 업데이트
                if (!stats.total_problems_solved) stats.total_problems_solved = 0;
                if (!stats.total_correct_answers) stats.total_correct_answers = 0;
                stats.total_problems_solved++;
                if (isCorrect) {
                    stats.total_correct_answers++;
                }
                stats.overall_accuracy = (stats.total_correct_answers / stats.total_problems_solved * 100).toFixed(1);
                
                // 데이터 저장
                localStorage.setItem('aicu_statistics', JSON.stringify(stats));
                
                // 실시간 UI 업데이트
                updateCategoryProgressDisplay(currentCategory);
                
                // 이벤트 발생
                triggerDataUpdateEvent(currentCategory, isCorrect);
                
                console.log('✅ 실시간 통계 업데이트 완료:', {
                    category: currentCategory,
                    isCorrect: isCorrect,
                    newStats: stats.categories[currentCategory]
                });
                
            } catch (error) {
                console.error('❌ 실시간 통계 업데이트 실패:', error);
            }
        }

        // 카테고리 진행률 표시 업데이트
        function updateCategoryProgressDisplay(category) {
            try {
                const statsData = localStorage.getItem('aicu_statistics') || '{}';
                const stats = JSON.parse(statsData);
                const categoryStats = stats.categories?.[category];
                
                if (categoryStats) {
                    const progressElement = document.getElementById(`progress-${category}`);
                    const accuracyElement = document.getElementById(`accuracy-${category}`);
                    
                    if (progressElement) {
                        const progressPercent = ((categoryStats.solved / getTotalQuestionsForCategory(category)) * 100).toFixed(1);
                        progressElement.textContent = `${progressPercent}%`;
                    }
                    
                    if (accuracyElement) {
                        accuracyElement.textContent = `${categoryStats.accuracy}%`;
                    }
                }
            } catch (error) {
                console.error('❌ 카테고리 진행률 표시 업데이트 실패:', error);
            }
        }

        // 카테고리별 총 문제 수 반환
        function getTotalQuestionsForCategory(category) {
            const questionCounts = {
                '06재산보험': 169,
                '07특종보험': 182,
                '08배상책임보험': 268,
                '09해상보험': 170
            };
            return questionCounts[category] || 100;
        }

        // 데이터 업데이트 이벤트 발생
        function triggerDataUpdateEvent(category, isCorrect) {
            const event = new CustomEvent('dataUpdated', {
                detail: {
                    category: category,
                    isCorrect: isCorrect,
                    timestamp: new Date().toISOString(),
                    source: 'large_category_learning'
                }
            });
            document.dispatchEvent(event);
        }

        // 일일 통계 계산
        function calculateDailyStats(category) {
            try {
                const statsData = localStorage.getItem('aicu_statistics') || '{}';
                const stats = JSON.parse(statsData);
                const categoryStats = stats.categories?.[category];
                
                if (categoryStats && categoryStats.daily_progress) {
                    const today = new Date().toISOString().split('T')[0];
                    const todayData = categoryStats.daily_progress[today] || { solved: 0, correct: 0 };
                    
                    return {
                        solved: todayData.solved,
                        correct: todayData.correct,
                        accuracy: todayData.solved > 0 ? (todayData.correct / todayData.solved * 100).toFixed(1) : '0'
                    };
                }
                
                return { solved: 0, correct: 0, accuracy: '0' };
            } catch (error) {
                console.error('❌ 일일 통계 계산 실패:', error);
                return { solved: 0, correct: 0, accuracy: '0' };
            }
        }

        // 누적 통계 계산
        function calculateCumulativeStats(category) {
            try {
                const statsData = localStorage.getItem('aicu_statistics') || '{}';
                const stats = JSON.parse(statsData);
                const categoryStats = stats.categories?.[category];
                
                if (categoryStats) {
                    return {
                        solved: categoryStats.solved || 0,
                        correct: categoryStats.correct || 0,
                        accuracy: categoryStats.accuracy || '0'
                    };
                }
                
                return { solved: 0, correct: 0, accuracy: '0' };
            } catch (error) {
                console.error('❌ 누적 통계 계산 실패:', error);
                return { solved: 0, correct: 0, accuracy: '0' };
            }
        }

        // 카테고리 학습 시작 이벤트 발생
        function triggerCategoryLearningStartEvent(category) {
            console.log('=== 카테고리 학습 시작 이벤트 발생 ===');
            
            const categoryLearningData = {
                category: category,
                learningType: 'large_category',
                timestamp: new Date().toISOString(),
                pageUrl: window.location.href
            };
            
            // 카테고리 학습 시작 이벤트 발생
            const event = new CustomEvent('categoryLearningStarted', {
                detail: categoryLearningData
            });
            
            document.dispatchEvent(event);
            console.log('✅ 카테고리 학습 시작 이벤트 발생 완료:', categoryLearningData);
        }

        // 카테고리 진도 초기화
        function resetCategoryProgress() {
            try {
                if (confirm('모든 카테고리의 진도를 초기화하시겠습니까?')) {
                    console.log('=== 카테고리 진도 초기화 ===');
                    
                    // 카테고리별 진행상황 초기화
                    localStorage.removeItem('aicu_category_progress');
                    
                    // 통계 데이터에서 카테고리별 데이터 초기화
                    const statsData = localStorage.getItem('aicu_statistics') || '{}';
                    const stats = JSON.parse(statsData);
                    
                    if (stats.categories) {
                        const categories = ['06재산보험', '07특종보험', '08배상책임보험', '09해상보험'];
                        categories.forEach(category => {
                            if (stats.categories[category]) {
                                stats.categories[category].solved = 0;
                                stats.categories[category].correct = 0;
                                stats.categories[category].accuracy = 0;
                                stats.categories[category].current_question_index = 0;
                                stats.categories[category].daily_progress = {};
                            }
                        });
                        
                        localStorage.setItem('aicu_statistics', JSON.stringify(stats));
                    }
                    
                    alert('카테고리 진도가 초기화되었습니다.');
                    location.reload();
                }
            } catch (error) {
                console.error('❌ 카테고리 진도 초기화 실패:', error);
                alert('초기화에 실패했습니다.');
            }
        }
    </script>
</body>
</html>
