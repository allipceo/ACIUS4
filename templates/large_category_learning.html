<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACIU S4 - ëŒ€ë¶„ë¥˜ í•™ìŠµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ê³µí†µ ì»´í¬ë„ŒíŠ¸ CSS -->
    <link rel="stylesheet" href="/static/css/question_ui.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- ìƒë‹¨ í—¤ë” -->
        <div class="flex justify-between items-center mb-8">
            <!-- ì¢Œì¸¡: ì‚¬ìš©ì ì •ë³´ -->
            <div class="flex items-center space-x-4">
                <div class="text-left">
                    <div class="text-sm text-gray-600">ì´ë¦„: <span id="user-name" class="font-medium text-gray-800">ë¡œë”© ì¤‘...</span></div>
                    <div class="text-sm text-gray-600">ìœ í˜•: <span id="user-type" class="font-medium text-gray-800">ë¡œë”© ì¤‘...</span></div>
                </div>
            </div>
            
            <!-- ì¤‘ì•™: ì œëª© -->
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ¯ ëŒ€ë¶„ë¥˜ í•™ìŠµ</h1>
                <p class="text-gray-600">ì¹´í…Œê³ ë¦¬ë³„ í•™ìŠµì„ í†µí•´ ì²´ê³„ì ìœ¼ë¡œ ì¤€ë¹„í•˜ì„¸ìš”</p>
            </div>
            
            <!-- ìš°ì¸¡: í™ˆìœ¼ë¡œ ë²„íŠ¼ -->
            <div>
                <a href="/home" 
                   class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                    ğŸ  í™ˆìœ¼ë¡œ
                </a>
            </div>
        </div>

        <!-- D-Day ì¹´ìš´í„° -->
        <div class="text-center mb-8">
            <div class="bg-white rounded-lg shadow-lg p-4 inline-block">
                <div class="flex items-center space-x-4">
                    <h3 class="text-lg font-bold text-gray-800">ğŸ“… ì‹œí—˜ê¹Œì§€ ë‚¨ì€ ì‹œê°„</h3>
                    <div id="dday-counter" class="text-2xl font-bold text-red-600"></div>
                </div>
            </div>
        </div>
                
        <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
        <div class="max-w-6xl mx-auto mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“š ì¹´í…Œê³ ë¦¬ ì„ íƒ</h3>
            <div class="grid grid-cols-4 gap-4">
                <!-- ì¬ì‚°ë³´í—˜ -->
                <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <div class="text-center">
                        <div class="text-4xl mb-4">ğŸ </div>
                        <h4 class="text-lg font-bold text-blue-800 mb-2">ì¬ì‚°ë³´í—˜</h4>
                        <p class="text-gray-600 mb-4">ì¬ì‚° ê´€ë ¨ ë³´í—˜ ë¬¸ì œ</p>
                        <div class="text-sm text-gray-500 mb-4">
                            <div>ì´ ë¬¸ì œ: <span class="font-medium">169ë¬¸ì œ</span></div>
                            <div>ì§„ë„: <span id="progress-ì¬ì‚°ë³´í—˜">0%</span></div>
                            <div>ì •ë‹µë¥ : <span id="accuracy-ì¬ì‚°ë³´í—˜">0%</span></div>
                        </div>
                        <button onclick="startCategoryLearning('ì¬ì‚°ë³´í—˜')" 
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            í•™ìŠµ ì‹œì‘
                        </button>
                    </div>
                </div>
                
                <!-- íŠ¹ì¢…ë³´í—˜ -->
                <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <div class="text-center">
                        <div class="text-4xl mb-4">ğŸš—</div>
                        <h4 class="text-lg font-bold text-green-800 mb-2">íŠ¹ì¢…ë³´í—˜</h4>
                        <p class="text-gray-600 mb-4">íŠ¹ìˆ˜ ì¢…ëª© ë³´í—˜ ë¬¸ì œ</p>
                        <div class="text-sm text-gray-500 mb-4">
                            <div>ì´ ë¬¸ì œ: <span class="font-medium">182ë¬¸ì œ</span></div>
                            <div>ì§„ë„: <span id="progress-íŠ¹ì¢…ë³´í—˜">0%</span></div>
                            <div>ì •ë‹µë¥ : <span id="accuracy-íŠ¹ì¢…ë³´í—˜">0%</span></div>
                        </div>
                        <button onclick="startCategoryLearning('íŠ¹ì¢…ë³´í—˜')" 
                                class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                            í•™ìŠµ ì‹œì‘
                        </button>
                    </div>
                </div>
                
                <!-- ë°°ìƒì±…ì„ë³´í—˜ -->
                <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <div class="text-center">
                        <div class="text-4xl mb-4">âš–ï¸</div>
                        <h4 class="text-lg font-bold text-yellow-800 mb-2">ë°°ìƒì±…ì„ë³´í—˜</h4>
                        <p class="text-gray-600 mb-4">ë°°ìƒ ì±…ì„ ë³´í—˜ ë¬¸ì œ</p>
                        <div class="text-sm text-gray-500 mb-4">
                            <div>ì´ ë¬¸ì œ: <span class="font-medium">268ë¬¸ì œ</span></div>
                            <div>ì§„ë„: <span id="progress-ë°°ìƒì±…ì„ë³´í—˜">0%</span></div>
                            <div>ì •ë‹µë¥ : <span id="accuracy-ë°°ìƒì±…ì„ë³´í—˜">0%</span></div>
                        </div>
                        <button onclick="startCategoryLearning('ë°°ìƒì±…ì„ë³´í—˜')" 
                                class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-colors">
                            í•™ìŠµ ì‹œì‘
                        </button>
                    </div>
                </div>
                
                <!-- í•´ìƒë³´í—˜ -->
                <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <div class="text-center">
                        <div class="text-4xl mb-4">ğŸš¢</div>
                        <h4 class="text-lg font-bold text-purple-800 mb-2">í•´ìƒë³´í—˜</h4>
                        <p class="text-gray-600 mb-4">í•´ìƒ ê´€ë ¨ ë³´í—˜ ë¬¸ì œ</p>
                        <div class="text-sm text-gray-500 mb-4">
                            <div>ì´ ë¬¸ì œ: <span class="font-medium">170ë¬¸ì œ</span></div>
                            <div>ì§„ë„: <span id="progress-í•´ìƒë³´í—˜">0%</span></div>
                            <div>ì •ë‹µë¥ : <span id="accuracy-í•´ìƒë³´í—˜">0%</span></div>
                        </div>
                        <button onclick="startCategoryLearning('í•´ìƒë³´í—˜')" 
                                class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                            í•™ìŠµ ì‹œì‘
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¬¸ì œ í’€ì´ ëª¨ë“ˆ ì»¨í…Œì´ë„ˆ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
    <div id="problem-module-container" class="hidden max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6 mb-8">
        <!-- ì¹´í…Œê³ ë¦¬ ì •ë³´ ë° ì§„ë„ í‘œì‹œ -->
        <div class="flex justify-between items-center mb-4 p-4 bg-gray-50 rounded-lg">
            <div class="flex items-center space-x-4">
                <h3 id="problem-category-title" class="text-lg font-bold text-gray-800">ì¹´í…Œê³ ë¦¬: <span id="current-category-name">ë¡œë”© ì¤‘...</span></h3>
                <span class="text-gray-600">|</span>
                <span id="problem-progress" class="text-sm text-gray-600">ì§„ë„: <span id="current-progress">0 / 0 (0%)</span></span>
            </div>
            <button onclick="hideProblemModule()" class="text-gray-500 hover:text-gray-700">
                <span class="text-xl">âœ•</span>
            </button>
        </div>

        <!-- ë¬¸ì œ í’€ì´ ëª¨ë“ˆ -->
        <div id="problem-module" class="mb-4">
            <!-- ë¬¸ì œ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
        </div>

        <!-- ë¬¸ì œ í’€ì´ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ -->
        <div class="flex justify-between items-center">
            <!-- ì¢Œì¸¡: ì´ì „/ì •ë‹µí™•ì¸/ë‹¤ìŒ ë²„íŠ¼ -->
            <div class="flex space-x-2">
                <button id="btn-prev" onclick="previousQuestion()" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    â† ì´ì „ë¬¸ì œ
                </button>
                <button id="btn-check" onclick="checkAnswer()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                    âœ“ ì •ë‹µí™•ì¸
                </button>
                <button id="btn-next" onclick="nextQuestion()" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    ë‹¤ìŒë¬¸ì œ â†’
                </button>
            </div>

            <!-- ìš°ì¸¡: ì²˜ìŒë¶€í„°/ëœë¤ í’€ê¸° ë²„íŠ¼ -->
            <div class="flex space-x-2">
                <button onclick="startFromBeginning()" 
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                    ğŸ”„ ì²˜ìŒë¶€í„°í’€ê¸°
                </button>
                <button onclick="startRandomMode()" 
                        class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                    ğŸ² ëœë¤í’€ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸš€ ì•¡ì…˜</h3>
        <div class="flex space-x-4">
            <button onclick="resetCategoryProgress()" 
                    class="flex-1 bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                ğŸ“Š ì¹´í…Œê³ ë¦¬ ì§„ë„ ì´ˆê¸°í™”
            </button>
            <a href="/" 
               class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors text-center">
                ğŸ  ëŒ€ë¬¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </a>
        </div>
    </div>

    <!-- ì‹œìŠ¤í…œ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
    <script src="/static/js/central_data_manager.js"></script>
    <script src="/static/js/realtime_sync_manager.js"></script>

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ë° í†µê³„ í‘œì‹œ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== ëŒ€ë¶„ë¥˜ í•™ìŠµ í˜ì´ì§€ ë¡œë“œ (SPA ë°©ì‹) ===');
            
            // localStorage ìš©ëŸ‰ ì´ˆê³¼ ë¬¸ì œ í•´ê²°
            clearExcessiveData();
            
            loadUserInfo();
            loadCategoryStatistics();
            
            // ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.addEventListener('dataUpdated', function() {
                console.log('ë°ì´í„° ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ ìˆ˜ì‹  - í†µê³„ ì¬ë¡œë“œ');
                loadCategoryStatistics();
            });
        });

        // localStorage ìš©ëŸ‰ ì´ˆê³¼ ë¬¸ì œ í•´ê²°
        function clearExcessiveData() {
            try {
                // í° ë°ì´í„° í•­ëª©ë“¤ ì •ë¦¬
                const keysToCheck = [
                    'aicu_quiz_results',
                    'aicu_category_statistics', 
                    'aicu_real_time_data',
                    'aicu_incorrect_statistics'
                ];
                
                keysToCheck.forEach(key => {
                    const data = localStorage.getItem(key);
                    if (data && data.length > 1000000) { // 1MB ì´ìƒì´ë©´ ì •ë¦¬
                        console.log(`í° ë°ì´í„° ì •ë¦¬: ${key} (${data.length} bytes)`);
                        localStorage.removeItem(key);
                    }
                });
                
                console.log('localStorage ì •ë¦¬ ì™„ë£Œ');
            } catch (error) {
                console.error('localStorage ì •ë¦¬ ì‹¤íŒ¨:', error);
            }
        }

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ë° í‘œì‹œ
        function loadUserInfo() {
            try {
                const userData = localStorage.getItem('aicu_user_data');
                
                if (userData) {
                    const user = JSON.parse(userData);
                    displayUserInfo(user);
                } else {
                    console.log('âŒ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ');
                    alert('ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.');
                    window.location.href = '/register';
                }
                
            } catch (error) {
                console.error('âŒ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = '/register';
            }
        }

        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        function displayUserInfo(user) {
            const userNameElement = document.getElementById('user-name');
            const userTypeElement = document.getElementById('user-type');
            const ddayCounterElement = document.getElementById('dday-counter');
            
            // ì‚¬ìš©ì ì´ë¦„ê³¼ ìœ í˜• í‘œì‹œ
            userNameElement.textContent = user.name;
            userTypeElement.textContent = user.user_type === 'guest' ? 'ê²ŒìŠ¤íŠ¸' : 'ì‹¤ì œ ì‚¬ìš©ì';
            userTypeElement.className = user.user_type === 'guest' ? 'font-medium text-blue-600' : 'font-medium text-green-600';
            
            // D-Day ê³„ì‚° ë° í‘œì‹œ
            const examDate = new Date(user.exam_date);
            const today = new Date();
            const timeDiff = examDate.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            const dDayText = daysDiff > 0 ? `D-${daysDiff}` : `D+${Math.abs(daysDiff)}`;
            
            ddayCounterElement.textContent = dDayText;
            ddayCounterElement.className = `text-2xl font-bold ${daysDiff <= 30 ? 'text-red-600' : 'text-blue-600'}`;
        }

                // ì¹´í…Œê³ ë¦¬ë³„ í†µê³„ ë¡œë“œ (ì¤‘ì•™ ì‹œìŠ¤í…œ ë°ì´í„° ì‚¬ìš©)
        function loadCategoryStatistics() {
            try {
                console.log('=== ëŒ€ë¶„ë¥˜ í•™ìŠµ í†µê³„ ë¡œë“œ ì‹œì‘ (ì¤‘ì•™ ì‹œìŠ¤í…œ) ===');
                
                // ì¤‘ì•™ ì‹œìŠ¤í…œì—ì„œ ë°ì´í„° ë¡œë“œ
                let centralData = null;
                if (window.CentralDataManager) {
                    const realTimeData = localStorage.getItem('aicu_real_time_data') || '{}';
                    centralData = JSON.parse(realTimeData);
                    console.log('âœ… ì¤‘ì•™ ì‹œìŠ¤í…œì—ì„œ ë°ì´í„° ë¡œë“œ:', centralData);
                } else {
                    const realTimeData = localStorage.getItem('aicu_real_time_data') || '{}';
                    centralData = JSON.parse(realTimeData);
                    console.log('âš ï¸ ì§ì ‘ LocalStorageì—ì„œ ë°ì´í„° ë¡œë“œ:', centralData);
                }
                
                // 4ê°œ ì¹´í…Œê³ ë¦¬ë§Œ ì²˜ë¦¬ (ì‚¬ìš©ì í‘œì‹œëª… ê¸°ì¤€)
                const categories = ['ì¬ì‚°ë³´í—˜', 'íŠ¹ì¢…ë³´í—˜', 'ë°°ìƒì±…ì„ë³´í—˜', 'í•´ìƒë³´í—˜'];
                const categoryTotals = {
                    'ì¬ì‚°ë³´í—˜': 169,
                    'íŠ¹ì¢…ë³´í—˜': 182,
                    'ë°°ìƒì±…ì„ë³´í—˜': 268,
                    'í•´ìƒë³´í—˜': 170
                };
                
                // ê° ì¹´í…Œê³ ë¦¬ë³„ í†µê³„ í‘œì‹œ
                categories.forEach(category => {
                    let categoryStats = { total: 0, correct: 0, solved: 0 };
                    
                    // ì¤‘ì•™ ì‹œìŠ¤í…œ ë°ì´í„°ì—ì„œ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì¶”ì¶œ (ë§¤í•‘ëœ ì´ë¦„ ì‚¬ìš©)
                    const mappedCategory = mapCategoryToSystemName(category);
                    if (centralData && centralData.categories && centralData.categories[mappedCategory]) {
                        const centralCategoryData = centralData.categories[mappedCategory];
                        categoryStats = {
                            total: categoryTotals[category],
                            correct: centralCategoryData.correct || 0,
                            solved: centralCategoryData.total || 0
                        };
                    }
                    
                    const progress = categoryStats.total > 0 
                        ? Math.round((categoryStats.solved / categoryStats.total) * 100) 
                        : 0;
                    const accuracy = categoryStats.solved > 0 
                        ? Math.round((categoryStats.correct / categoryStats.solved) * 100) 
                        : 0;
                    
                    // ì¹´ë“œ ì—…ë°ì´íŠ¸
                    const progressElement = document.getElementById(`progress-${category}`);
                    const accuracyElement = document.getElementById(`accuracy-${category}`);
                    
                    if (progressElement) progressElement.textContent = `${progress}%`;
                    if (accuracyElement) accuracyElement.textContent = `${accuracy}%`;
                    
                    console.log(`ğŸ“Š ${category}: ì§„í–‰ë¥  ${progress}%, ì •ë‹µë¥  ${accuracy}% (í‘¼ ë¬¸ì œ: ${categoryStats.solved}, ì •ë‹µ: ${categoryStats.correct})`);
                });
            } catch (error) {
                console.error('âŒ ì¹´í…Œê³ ë¦¬ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì¹´í…Œê³ ë¦¬ëª… ë§¤í•‘ í•¨ìˆ˜ (ì‚¬ìš©ì í‘œì‹œëª… â†’ ì‹œìŠ¤í…œ ë‚´ë¶€ëª…)
        function mapCategoryToSystemName(categoryName) {
            const categoryMapping = {
                'ì¬ì‚°ë³´í—˜': '06ì¬ì‚°ë³´í—˜',
                'íŠ¹ì¢…ë³´í—˜': '07íŠ¹ì¢…ë³´í—˜',
                'ë°°ìƒì±…ì„ë³´í—˜': '08ë°°ìƒì±…ì„ë³´í—˜',
                'í•´ìƒë³´í—˜': '09í•´ìƒë³´í—˜'
            };
            return categoryMapping[categoryName] || categoryName;
        }





        // ì¹´í…Œê³ ë¦¬ í•™ìŠµ ì‹œì‘ (ìƒˆë¡œìš´ SPA ë°©ì‹)
        function startCategoryLearning(category) {
            console.log(`=== ${category} ì¹´í…Œê³ ë¦¬ í•™ìŠµ ì‹œì‘ (SPA ë°©ì‹) ===`);
            
            // í˜„ì¬ ì¹´í…Œê³ ë¦¬ ì •ë³´ë¥¼ LocalStorageì— ì €ì¥
            localStorage.setItem('aicu_current_category', category);
            
            // ë¬¸ì œ í’€ì´ ëª¨ë“ˆ í‘œì‹œ
            showProblemModule(category);
        }

        // ë¬¸ì œ í’€ì´ ëª¨ë“ˆ í‘œì‹œ
        function showProblemModule(category) {
            console.log('showProblemModule í˜¸ì¶œë¨:', category);
            
            const container = document.getElementById('problem-module-container');
            const categoryName = document.getElementById('current-category-name');
            
            if (!container) {
                console.error('problem-module-containerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                alert('ë¬¸ì œ ëª¨ë“ˆ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            if (!categoryName) {
                console.error('current-category-nameì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                alert('ì¹´í…Œê³ ë¦¬ëª… ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            // ì¹´í…Œê³ ë¦¬ëª… í‘œì‹œ
            categoryName.textContent = category;
            
            // ëª¨ë“ˆ í‘œì‹œ
            container.classList.remove('hidden');
            console.log('ë¬¸ì œ ëª¨ë“ˆì´ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // ì²« ë²ˆì§¸ ë¬¸ì œ ë¡œë“œ
            loadQuestion(category, 0);
            
            // í˜ì´ì§€ ìŠ¤í¬ë¡¤ì„ ëª¨ë“ˆë¡œ ì´ë™
            container.scrollIntoView({ behavior: 'smooth' });
        }

        // ë¬¸ì œ í’€ì´ ëª¨ë“ˆ ìˆ¨ê¸°ê¸°
        function hideProblemModule() {
            const container = document.getElementById('problem-module-container');
            container.classList.add('hidden');
        }

        // ë¬¸ì œ ë¡œë“œ
        function loadQuestion(category, questionIndex) {
            console.log(`ë¬¸ì œ ë¡œë“œ: ${category} - ${questionIndex}ë²ˆ`);
            
            // ì¹´í…Œê³ ë¦¬ ë§¤í•‘
            const systemCategory = mapCategoryToSystemName(category);
            console.log(`ì¹´í…Œê³ ë¦¬ ë§¤í•‘: ${category} â†’ ${systemCategory}`);
            
            // ì‹¤ì œ API í˜¸ì¶œë¡œ ë¬¸ì œ ë°ì´í„° ë¡œë“œ
            fetch(`/api/questions?category=${encodeURIComponent(systemCategory)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.questions && data.questions.length > 0) {
                        const question = data.questions[questionIndex] || data.questions[0];
                        displayQuestion(question, category, questionIndex);
                        updateProgress(category, questionIndex, data.questions.length);
                        console.log(`âœ… ë¬¸ì œ ë¡œë“œ ì„±ê³µ: ${data.questions.length}ê°œ ë¬¸ì œ`);
                    } else {
                        displayNoQuestions(category);
                        console.log(`âš ï¸ ${category} ì¹´í…Œê³ ë¦¬ì— ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.`);
                    }
                })
                .catch(error => {
                    console.error('ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨:', error);
                    // API ì‹¤íŒ¨ ì‹œ í…ŒìŠ¤íŠ¸ ë¬¸ì œ í‘œì‹œ
                    const testQuestion = {
                        id: 1,
                        question: `${category} í…ŒìŠ¤íŠ¸ ë¬¸ì œì…ë‹ˆë‹¤. ì´ê²ƒì€ ì„ì‹œ ë¬¸ì œì…ë‹ˆë‹¤.`,
                        answer: 'O',
                        type: 'ì§„ìœ„í˜•'
                    };
                    displayQuestion(testQuestion, category, questionIndex);
                    updateProgress(category, questionIndex, 100);
                });
        }

        // ë¬¸ì œ í‘œì‹œ (ê³µí†µ ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©)
        function displayQuestion(question, category, questionIndex) {
            try {
                console.log('ğŸ“‹ ëŒ€ë¶„ë¥˜í•™ìŠµ ë¬¸ì œ í‘œì‹œ ì‹œì‘:', question.qcode);
                
                // ë¬¸ì œ ëª¨ë“ˆ ì»¨í…Œì´ë„ˆ ìƒì„±
                const module = document.getElementById('problem-module');
                module.innerHTML = `
                    <div class="bg-gray-50 rounded-lg p-6 mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <span id="question-code" class="text-sm text-gray-600">ë¬¸ì œ ${questionIndex + 1}</span>
                            <span id="question-type" class="text-sm text-gray-600">${category} (${question.type})</span>
                        </div>
                        <div id="layer-info" class="text-sm text-gray-500 mb-2">${question.layer1 || ''} > ${question.layer2 || ''}</div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-sm text-gray-600">ì§„ë„</span>
                            <span id="progress-info" class="text-sm font-medium text-blue-600">${questionIndex + 1} / ë¡œë”© ì¤‘...</span>
                        </div>
                        <div id="question-text" class="text-lg font-medium mb-6 whitespace-pre-line">${question.question || 'ë¬¸ì œ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</div>
                        
                        <div id="answer-buttons" class="mb-4">
                            <!-- ì„ íƒì§€ ë²„íŠ¼ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                        </div>
                        
                        <div class="flex justify-center space-x-4">
                            <button onclick="previousQuestion()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                                ì´ì „ ë¬¸ì œ
                            </button>
                            <button onclick="checkAnswer()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                                ì •ë‹µ í™•ì¸
                            </button>
                            <button onclick="nextQuestion()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                                ë‹¤ìŒ ë¬¸ì œ
                            </button>
                        </div>
                    </div>
                `;
                
                // ê³µí†µ ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬¸ì œ í‘œì‹œ
                if (window.QuestionDisplayManager) {
                    window.QuestionDisplayManager.displayQuestion(question, questionIndex, 100, {
                        isCategoryMode: true,
                        currentCategory: category
                    });
                }
                
                // ê³µí†µ ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„ íƒì§€ ìƒì„±
                if (window.AnswerButtonManager) {
                    window.AnswerButtonManager.createAnswerButtons(question, 'answer-buttons');
                }
                
                // ê²°ê³¼ í‘œì‹œ ì´ˆê¸°í™”
                if (window.ResultDisplayManager) {
                    window.ResultDisplayManager.resetResult();
                }
                
                // í˜„ì¬ ë¬¸ì œ ì •ë³´ ì €ì¥
                window.currentQuestion = {
                    id: question.qcode || questionIndex,
                    category: category,
                    index: questionIndex,
                    correctAnswer: question.answer || 'O',
                    type: question.type || 'ì§„ìœ„í˜•'
                };
                
                console.log('âœ… ëŒ€ë¶„ë¥˜í•™ìŠµ ë¬¸ì œ í‘œì‹œ ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ ëŒ€ë¶„ë¥˜í•™ìŠµ ë¬¸ì œ í‘œì‹œ ì‹¤íŒ¨:', error);
            }
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress(category, currentIndex, totalQuestions) {
            const progressElement = document.getElementById('current-progress');
            const percentage = totalQuestions > 0 ? Math.round((currentIndex / totalQuestions) * 100) : 0;
            progressElement.textContent = `${currentIndex + 1} / ${totalQuestions} (${percentage}%)`;
        }

        // ì •ë‹µ í™•ì¸ (ê³µí†µ ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©)
        function checkAnswer() {
            // ê³µí†µ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì„ íƒëœ ë‹µì•ˆ ê°€ì ¸ì˜¤ê¸°
            const userAnswer = window.AnswerButtonManager ? window.AnswerButtonManager.getSelectedAnswer() : null;
            
            if (!userAnswer) {
                alert('ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!window.currentQuestion) {
                alert('ë¬¸ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const isCorrect = userAnswer === window.currentQuestion.correctAnswer;
            
            console.log('ëŒ€ë¶„ë¥˜í•™ìŠµ ì •ë‹µ í™•ì¸:', {
                userAnswer: userAnswer,
                correctAnswer: window.currentQuestion.correctAnswer,
                isCorrect: isCorrect,
                questionType: window.currentQuestion.type
            });
            
            // ì¤‘ì•™ ë°ì´í„° ê´€ë¦¬ìì— ê²°ê³¼ ì „ì†¡ (ì‹œìŠ¤í…œ ì¹´í…Œê³ ë¦¬ëª… ì‚¬ìš©)
            if (window.CentralDataManager && typeof window.CentralDataManager.recordQuizResult === 'function') {
                const systemCategory = mapCategoryToSystemName(window.currentQuestion.category);
                window.CentralDataManager.recordQuizResult(
                    window.currentQuestion.id,
                    systemCategory,
                    isCorrect,
                    userAnswer,
                    window.currentQuestion.correctAnswer
                );
                console.log(`âœ… ì¤‘ì•™ ë°ì´í„° ê´€ë¦¬ìì— ê²°ê³¼ ì „ì†¡: ${systemCategory}`);
            }

            // ê³µí†µ ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ë‹µ ê²°ê³¼ í‘œì‹œ
            if (window.ResultDisplayManager) {
                window.ResultDisplayManager.showInlineResult(userAnswer, window.currentQuestion.correctAnswer, window.currentQuestion);
            }
            
            // ê³µí†µ ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„ íƒì§€ ìƒ‰ìƒ ë³€ê²½
            if (window.AnswerButtonManager) {
                window.AnswerButtonManager.showAnswerResult(window.currentQuestion.correctAnswer);
            }
            
            // ì¹´í…Œê³ ë¦¬ í†µê³„ ì—…ë°ì´íŠ¸
            setTimeout(() => {
                loadCategoryStatistics();
            }, 100);
        }

        // ì •ë‹µ ê²°ê³¼ í‘œì‹œ
        function showAnswerResult(isCorrect, userAnswer, correctAnswer) {
            const module = document.getElementById('problem-module');
            const resultDiv = document.createElement('div');
            
            // ë‹µì•ˆ í…ìŠ¤íŠ¸ ë³€í™˜
            const getAnswerText = (answer) => {
                if (answer === 'O') return 'ë§ìŒ';
                if (answer === 'X') return 'í‹€ë¦¼';
                return `${answer}ë²ˆ`;
            };
            
            resultDiv.className = `fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50`;
            resultDiv.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
                    <div class="text-6xl mb-4">${isCorrect ? 'âœ…' : 'âŒ'}</div>
                    <h3 class="text-xl font-bold mb-2">${isCorrect ? 'ì •ë‹µì…ë‹ˆë‹¤!' : 'í‹€ë ¸ìŠµë‹ˆë‹¤.'}</h3>
                    <p class="text-gray-600 mb-4">
                        ì„ íƒí•œ ë‹µ: ${getAnswerText(userAnswer)}<br>
                        ì •ë‹µ: ${getAnswerText(correctAnswer)}
                    </p>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                        í™•ì¸
                    </button>
                </div>
            `;
            
            document.body.appendChild(resultDiv);
        }

        // ì´ì „ ë¬¸ì œ
        function previousQuestion() {
            if (window.currentQuestion && window.currentQuestion.index > 0) {
                loadQuestion(window.currentQuestion.category, window.currentQuestion.index - 1);
            }
        }

        // ë‹¤ìŒ ë¬¸ì œ
        function nextQuestion() {
            if (window.currentQuestion) {
                loadQuestion(window.currentQuestion.category, window.currentQuestion.index + 1);
            }
        }

        // ì²˜ìŒë¶€í„° í’€ê¸°
        function startFromBeginning() {
            if (window.currentQuestion) {
                loadQuestion(window.currentQuestion.category, 0);
            }
        }

        // ëœë¤ í’€ê¸°
        function startRandomMode() {
            if (window.currentQuestion) {
                const randomIndex = Math.floor(Math.random() * 100); // ì„ì‹œë¡œ 100ê°œ ë¬¸ì œ ê°€ì •
                loadQuestion(window.currentQuestion.category, randomIndex);
            }
        }

        // ë¬¸ì œ ì—†ìŒ í‘œì‹œ
        function displayNoQuestions(category) {
            const module = document.getElementById('problem-module');
            module.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-4xl mb-4">ğŸ“š</div>
                    <h3 class="text-xl font-bold mb-2">ë¬¸ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p class="text-gray-600">${category} ì¹´í…Œê³ ë¦¬ì˜ ë¬¸ì œê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                </div>
            `;
        }

        // ì—ëŸ¬ í‘œì‹œ
        function displayError(message) {
            const module = document.getElementById('problem-module');
            module.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-4xl mb-4">âš ï¸</div>
                    <h3 class="text-xl font-bold mb-2">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h3>
                    <p class="text-gray-600">${message}</p>
                </div>
            `;
        }

        // ì¹´í…Œê³ ë¦¬ ì§„ë„ ì´ˆê¸°í™”
        function resetCategoryProgress() {
            if (confirm('ì •ë§ë¡œ ëª¨ë“  ì¹´í…Œê³ ë¦¬ì˜ í•™ìŠµ ì§„ë„ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                try {
                    const statsData = localStorage.getItem('aicu_statistics') || '{}';
                    const stats = JSON.parse(statsData);
                    
                    // 4ê°œ ì¹´í…Œê³ ë¦¬ë§Œ ì´ˆê¸°í™” (ì˜¬ë°”ë¥¸ ì¹´í…Œê³ ë¦¬ëª… ì‚¬ìš©)
                    const categories = ['ì¬ì‚°ë³´í—˜', 'íŠ¹ì¢…ë³´í—˜', 'ë°°ìƒì±…ì„ë³´í—˜', 'í•´ìƒë³´í—˜'];
                    const categoryTotals = {
                        'ì¬ì‚°ë³´í—˜': 169,
                        'íŠ¹ì¢…ë³´í—˜': 182,
                        'ë°°ìƒì±…ì„ë³´í—˜': 268,
                        'í•´ìƒë³´í—˜': 170
                    };
                    
                    // ì¹´í…Œê³ ë¦¬ë³„ ë°ì´í„° ì´ˆê¸°í™”
                    if (!stats.categories) stats.categories = {};
                    
                    categories.forEach(category => {
                        stats.categories[category] = {
                            solved: 0,
                            correct: 0,
                            total: categoryTotals[category],
                            current_question_index: 0,
                            daily_progress: {}
                        };
                    });
                    
                    // ì¹´í…Œê³ ë¦¬ë³„ ì§„í–‰ìƒí™©ë„ ì´ˆê¸°í™”
                    const categoryProgress = {};
                    categories.forEach(category => {
                        categoryProgress[category] = {
                            currentQuestionIndex: 0,
                            lastUpdated: new Date().toISOString()
                        };
                    });
                    localStorage.setItem('aicu_category_progress', JSON.stringify(categoryProgress));
                    
                    // ì—…ë°ì´íŠ¸ëœ í†µê³„ ì €ì¥
                    localStorage.setItem('aicu_statistics', JSON.stringify(stats));
                    
                    alert('ì¹´í…Œê³ ë¦¬ ì§„ë„ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    console.log('âœ… ì¹´í…Œê³ ë¦¬ ì§„ë„ ì´ˆê¸°í™” ì™„ë£Œ');
                    
                    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                    location.reload();
                    
                } catch (error) {
                    console.error('âŒ ì¹´í…Œê³ ë¦¬ ì§„ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    alert('ì¹´í…Œê³ ë¦¬ ì§„ë„ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }
    </script>
    
    <!-- ê³µí†µ ì»´í¬ë„ŒíŠ¸ JavaScript -->
    <script src="/static/js/question_display_manager.js"></script>
    <script src="/static/js/answer_button_manager.js"></script>
    <script src="/static/js/result_display_manager.js"></script>
    <script src="/static/js/central_data_manager.js"></script>
    <script src="/static/js/realtime_sync_manager.js"></script>
</body>
</html>
