<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACIU S4 - 대분류 학습</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 헤더 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">🎯 대분류 학습</h1>
            <p class="text-gray-600">카테고리별 학습을 통해 체계적으로 준비하세요</p>
        </div>

        <!-- 사용자 정보 -->
        <div id="user-info" class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">👤 현재 사용자</h2>
            <div id="user-details" class="space-y-2">
                <!-- 사용자 정보가 여기에 동적으로 표시됩니다 -->
                    </div>
                </div>
                
        <!-- 카테고리 선택 -->
        <div class="max-w-4xl mx-auto mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">📚 카테고리 선택</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 보험법 -->
                <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <div class="text-center">
                        <div class="text-4xl mb-4">⚖️</div>
                        <h4 class="text-lg font-bold text-blue-800 mb-2">보험법</h4>
                        <p class="text-gray-600 mb-4">보험 관련 법규 및 제도</p>
                        <div class="text-sm text-gray-500 mb-4">
                            <div>총 문제: <span class="font-medium">200문제</span></div>
                            <div>진도: <span id="progress-보험법">0%</span></div>
                            <div>정답률: <span id="accuracy-보험법">0%</span></div>
                        </div>
                        <button onclick="startCategoryLearning('보험법')" 
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            학습 시작
                        </button>
                    </div>
                </div>
                
                <!-- 보험상품 -->
                <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <div class="text-center">
                        <div class="text-4xl mb-4">📋</div>
                        <h4 class="text-lg font-bold text-green-800 mb-2">보험상품</h4>
                        <p class="text-gray-600 mb-4">다양한 보험상품의 특징</p>
                        <div class="text-sm text-gray-500 mb-4">
                            <div>총 문제: <span class="font-medium">200문제</span></div>
                            <div>진도: <span id="progress-보험상품">0%</span></div>
                            <div>정답률: <span id="accuracy-보험상품">0%</span></div>
                        </div>
                        <button onclick="startCategoryLearning('보험상품')" 
                                class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                            학습 시작
                        </button>
                    </div>
                </div>
                
                <!-- 보험영업 -->
                <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <div class="text-center">
                        <div class="text-4xl mb-4">💼</div>
                        <h4 class="text-lg font-bold text-purple-800 mb-2">보험영업</h4>
                        <p class="text-gray-600 mb-4">보험 영업 및 고객 관리</p>
                        <div class="text-sm text-gray-500 mb-4">
                            <div>총 문제: <span class="font-medium">200문제</span></div>
                            <div>진도: <span id="progress-보험영업">0%</span></div>
                            <div>정답률: <span id="accuracy-보험영업">0%</span></div>
                        </div>
                        <button onclick="startCategoryLearning('보험영업')" 
                                class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                            학습 시작
                        </button>
                    </div>
                </div>
                
                <!-- 보험계리 -->
                <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <div class="text-center">
                        <div class="text-4xl mb-4">🧮</div>
                        <h4 class="text-lg font-bold text-orange-800 mb-2">보험계리</h4>
                        <p class="text-gray-600 mb-4">보험료 계산 및 위험 관리</p>
                        <div class="text-sm text-gray-500 mb-4">
                            <div>총 문제: <span class="font-medium">189문제</span></div>
                            <div>진도: <span id="progress-보험계리">0%</span></div>
                            <div>정답률: <span id="accuracy-보험계리">0%</span></div>
                        </div>
                        <button onclick="startCategoryLearning('보험계리')" 
                                class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                            학습 시작
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- 학습 통계 -->
        <div class="max-w-4xl mx-auto mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">📊 카테고리별 학습 통계</h3>
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="category-stats">
                    <!-- 카테고리별 통계가 여기에 동적으로 표시됩니다 -->
                </div>
            </div>
        </div>

        <!-- 액션 버튼들 -->
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">🚀 액션</h3>
            <div class="space-y-3">
                <button onclick="resetCategoryProgress()" 
                        class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                    📊 카테고리 진도 초기화
                </button>
                <a href="/home" 
                   class="block w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors text-center">
                    🏠 대문으로 돌아가기
                </a>
            </div>
        </div>
    </div>

    <script>
        // 페이지 로드 시 사용자 정보 및 통계 표시
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== 대분류 학습 페이지 로드 ===');
            loadUserInfo();
            loadCategoryStatistics();
        });

        // 사용자 정보 로드 및 표시
        function loadUserInfo() {
            try {
                const userData = localStorage.getItem('aicu_user_data');
                
                if (userData) {
                    const user = JSON.parse(userData);
                    displayUserInfo(user);
                } else {
                    console.log('❌ 사용자 정보 없음');
                    alert('사용자 정보가 없습니다. 먼저 등록해주세요.');
                    window.location.href = '/register';
                }
                
            } catch (error) {
                console.error('❌ 사용자 정보 로드 실패:', error);
                alert('사용자 정보를 불러올 수 없습니다.');
                window.location.href = '/register';
            }
        }

        // 사용자 정보 표시
        function displayUserInfo(user) {
            const userDetailsElement = document.getElementById('user-details');
            
            // D-Day 계산
            const examDate = new Date(user.exam_date);
            const today = new Date();
            const timeDiff = examDate.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            const dDayText = daysDiff > 0 ? `D-${daysDiff}` : `D+${Math.abs(daysDiff)}`;
            
            userDetailsElement.innerHTML = `
                <div class="flex justify-between">
                    <span class="font-medium">이름:</span>
                    <span>${user.name}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">유형:</span>
                    <span class="${user.user_type === 'guest' ? 'text-blue-600' : 'text-green-600'}">
                        ${user.user_type === 'guest' ? '게스트' : '실제 사용자'}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">D-Day:</span>
                    <span class="font-bold ${daysDiff <= 30 ? 'text-red-600' : 'text-blue-600'}">${dDayText}</span>
                </div>
            `;
        }

        // 카테고리별 통계 로드
        function loadCategoryStatistics() {
            try {
                console.log('=== 대분류 학습 통계 로드 시작 ===');
                const statsData = localStorage.getItem('aicu_statistics') || '{}';
                const stats = JSON.parse(statsData);
                
                // 4개 카테고리만 처리 (JSON 파일 기준)
                const categories = ['06재산보험', '07특종보험', '08배상책임보험', '09해상보험'];
                const categoryTotals = {
                    '06재산보험': 169,
                    '07특종보험': 182,
                    '08배상책임보험': 268,
                    '09해상보험': 170
                };
                
                // 각 카테고리별 통계 표시
                categories.forEach(category => {
                    const categoryStats = stats.categories && stats.categories[category] 
                        ? stats.categories[category] 
                        : { solved: 0, correct: 0, total: categoryTotals[category] };
                    
                    const progress = categoryStats.total > 0 
                        ? Math.round((categoryStats.solved / categoryStats.total) * 100) 
                        : 0;
                    const accuracy = categoryStats.solved > 0 
                        ? Math.round((categoryStats.correct / categoryStats.solved) * 100) 
                        : 0;
                    
                    // 카드 업데이트
                    const progressElement = document.getElementById(`progress-${category}`);
                    const accuracyElement = document.getElementById(`accuracy-${category}`);
                    
                    if (progressElement) progressElement.textContent = `${progress}%`;
                    if (accuracyElement) accuracyElement.textContent = `${accuracy}%`;
                    
                    console.log(`📊 ${category}: 진행률 ${progress}%, 정답률 ${accuracy}%`);
                });
                
                // 상세 통계 표시
                displayCategoryStats(stats.categories || {});
                
            } catch (error) {
                console.error('❌ 카테고리 통계 로드 실패:', error);
            }
        }

        // 카테고리별 상세 통계 표시
        function displayCategoryStats(categories) {
            const statsContainer = document.getElementById('category-stats');
            
            // 4개 카테고리만 필터링
            const validCategories = ['보험법', '보험상품', '보험영업', '보험계리'];
            const filteredCategories = {};
            
            for (const category of validCategories) {
                if (categories[category]) {
                    filteredCategories[category] = categories[category];
                }
            }
            
            if (Object.keys(filteredCategories).length === 0) {
                statsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">아직 카테고리별 데이터가 없습니다.</p>';
                return;
            }
            
            let html = '';
            for (const [category, data] of Object.entries(filteredCategories)) {
                const progress = data.total > 0 ? Math.round((data.solved / data.total) * 100) : 0;
                const accuracy = data.solved > 0 ? Math.round((data.correct / data.solved) * 100) : 0;
                
                html += `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-bold text-gray-800 mb-2">${category}</h4>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span>진도:</span>
                                <span class="font-medium">${progress}% (${data.solved}/${data.total})</span>
                            </div>
                            <div class="flex justify-between">
                                <span>정답률:</span>
                                <span class="font-medium text-blue-600">${accuracy}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span>정답:</span>
                                <span class="font-medium text-green-600">${data.correct}문제</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            statsContainer.innerHTML = html;
        }

        // 카테고리 학습 시작
        function startCategoryLearning(category) {
            console.log(`=== ${category} 카테고리 학습 시작 ===`);
            
            // 현재 카테고리 정보를 LocalStorage에 저장
            localStorage.setItem('aicu_current_category', category);
            
            // 기본 학습 페이지로 이동 (카테고리 필터링 적용)
            window.location.href = '/basic-learning';
        }

        // 카테고리 진도 초기화
        function resetCategoryProgress() {
            if (confirm('정말로 모든 카테고리의 학습 진도를 초기화하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
                try {
                    const statsData = localStorage.getItem('aicu_statistics') || '{}';
                    const stats = JSON.parse(statsData);
                    
                    // 4개 카테고리만 초기화
                    const categories = ['보험법', '보험상품', '보험영업', '보험계리'];
                    const categoryTotals = {
                        '보험법': 200,
                        '보험상품': 200,
                        '보험영업': 200,
                        '보험계리': 189
                    };
                    
                    // 카테고리별 데이터 초기화
                    if (!stats.categories) stats.categories = {};
                    
                    categories.forEach(category => {
                        stats.categories[category] = {
                            solved: 0,
                            correct: 0,
                            total: categoryTotals[category],
                            current_question_index: 0,
                            daily_progress: {}
                        };
                    });
                    
                    // 카테고리별 진행상황도 초기화
                    const categoryProgress = {};
                    categories.forEach(category => {
                        categoryProgress[category] = {
                            currentQuestionIndex: 0,
                            lastUpdated: new Date().toISOString()
                        };
                    });
                    localStorage.setItem('aicu_category_progress', JSON.stringify(categoryProgress));
                    
                    // 업데이트된 통계 저장
                    localStorage.setItem('aicu_statistics', JSON.stringify(stats));
                    
                    alert('카테고리 진도가 초기화되었습니다.');
                    console.log('✅ 카테고리 진도 초기화 완료');
                    
                    // 페이지 새로고침
                    location.reload();
                    
                } catch (error) {
                    console.error('❌ 카테고리 진도 초기화 실패:', error);
                    alert('카테고리 진도 초기화에 실패했습니다.');
                }
            }
        }
    </script>
</body>
</html>
