<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACIU S4 - 사용자 등록</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto">
        <!-- 헤더 -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ACIU S4</h1>
                <p class="text-gray-600">사용자 등록을 진행해주세요</p>
            </div>

            <!-- 등록 옵션 선택 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- 게스트 등록 -->
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-blue-200 hover:border-blue-400 transition-colors">
                    <div class="text-center">
                        <div class="text-4xl mb-4">👤</div>
                        <h2 class="text-xl font-bold text-blue-800 mb-2">게스트로 등록</h2>
                        <p class="text-gray-600 mb-4">간단한 정보로 빠르게 시작</p>
                        <button onclick="showGuestRegistration()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                            게스트 등록
                        </button>
                    </div>
                </div>

                <!-- 실제 사용자 등록 -->
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-green-200 hover:border-green-400 transition-colors">
                    <div class="text-center">
                        <div class="text-4xl mb-4">🎯</div>
                        <h2 class="text-xl font-bold text-green-800 mb-2">실제 사용자 등록</h2>
                        <p class="text-gray-600 mb-4">개인화된 학습을 위한 상세 등록</p>
                        <button onclick="showUserRegistration()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                            사용자 등록
                        </button>
                    </div>
                </div>
                    </div>
                    
            <!-- 게스트 등록 폼 -->
            <div id="guest-registration-form" class="hidden bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-blue-800 mb-4">게스트 등록</h3>
                <form id="guest-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">성명</label>
                        <input type="text" id="guest-name" value="게스트" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">시험</label>
                        <input type="text" id="guest-exam" value="ACIU" readonly
                               class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">시험일</label>
                        <input type="date" id="guest-exam-date" value="2025-09-13" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="flex space-x-4">
                        <button type="button" onclick="hideGuestRegistration()" 
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            취소
                        </button>
                        <button type="submit" 
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            게스트 등록
                    </button>
                </div>
            </form>
        </div>

            <!-- 실제 사용자 등록 폼 -->
            <div id="user-registration-form" class="hidden bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-green-800 mb-4">실제 사용자 등록</h3>
                <form id="user-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">이름 *</label>
                        <input type="text" id="user-name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                               placeholder="이름을 입력하세요">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">전화번호 *</label>
                        <input type="tel" id="user-phone" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                               placeholder="010-1234-5678">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">시험</label>
                        <input type="text" id="user-exam" value="ACIU" readonly
                               class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">시험일 *</label>
                        <input type="date" id="user-exam-date" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            
                    <div class="flex space-x-4">
                        <button type="button" onclick="hideUserRegistration()" 
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            취소
                </button>
                        <button type="submit" 
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                            사용자 등록
                </button>
            </div>
                </form>
            </div>

            <!-- 상태 메시지 -->
            <div id="status-message" class="hidden mt-4 p-4 rounded-lg"></div>
        </div>
    </div>

    <script>
        // 게스트 등록 폼 표시
        function showGuestRegistration() {
            document.getElementById('guest-registration-form').classList.remove('hidden');
            document.getElementById('user-registration-form').classList.add('hidden');
        }

        // 게스트 등록 폼 숨기기
        function hideGuestRegistration() {
            document.getElementById('guest-registration-form').classList.add('hidden');
        }

        // 실제 사용자 등록 폼 표시
        function showUserRegistration() {
            document.getElementById('user-registration-form').classList.remove('hidden');
            document.getElementById('guest-registration-form').classList.add('hidden');
        }

        // 실제 사용자 등록 폼 숨기기
        function hideUserRegistration() {
            document.getElementById('user-registration-form').classList.add('hidden');
        }

        // 상태 메시지 표시
        function showStatusMessage(message, type = 'info') {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.className = `mt-4 p-4 rounded-lg ${type === 'error' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
            statusElement.classList.remove('hidden');
        }

        // 등록 시점 기반 통계 초기화
        function initializeUserStatistics(userData) {
            try {
                console.log('=== 등록 시점 기반 통계 초기화 시작 ===');
                
                const registrationTimestamp = userData.created_at || new Date().toISOString();
                const today = new Date().toISOString().split('T')[0];
                
                // 기본 통계 구조 생성
                const statistics = {
                    registration_timestamp: registrationTimestamp,
                    total_questions_attempted: 0,
                    total_correct_answers: 0,
                    total_study_time: 0,
                    accuracy_rate: 0,
                    daily_progress: {
                        [today]: {
                            attempted: 0,
                            correct: 0,
                            time: 0,
                            accuracy: 0
                        }
                    },
                    last_updated: registrationTimestamp
                };
                
                // 학습 로그 초기화
                const learningLog = [];
                
                // LocalStorage에 저장
                localStorage.setItem('aicu_statistics', JSON.stringify(statistics));
                localStorage.setItem('aicu_learning_log', JSON.stringify(learningLog));
                
                console.log('✅ 등록 시점 기반 통계 초기화 완료:', statistics);
                console.log('📅 등록 시점:', registrationTimestamp);
                    
                } catch (error) {
                console.error('❌ 통계 초기화 실패:', error);
            }
        }

        // 게스트 등록 처리
        document.getElementById('guest-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const guestData = {
                name: document.getElementById('guest-name').value,
                exam_date: document.getElementById('guest-exam-date').value
            };

            try {
                const response = await fetch('/api/register/guest', {
                        method: 'POST',
                        headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(guestData)
                });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                    // LocalStorage에 사용자 정보 저장
                    localStorage.setItem('aicu_user_data', JSON.stringify(result.user_data));
                    
                    // 등록 완료 플래그 설정 (홈페이지 접근 제어용)
                    const registrationData = {
                        type: 'guest',
                        registration_timestamp: result.user_data.created_at,
                        is_permanent: true,
                        user_name: result.user_data.name,
                        registration_date: result.user_data.registration_date.split('T')[0]
                    };
                    localStorage.setItem('aicu_registration_completed', JSON.stringify(registrationData));
                    localStorage.setItem('aicu_registration_timestamp', result.user_data.created_at);
                    
                    // 등록 시점 기반 통계 초기화
                    initializeUserStatistics(result.user_data);
                    
                    showStatusMessage('게스트 등록이 완료되었습니다!', 'success');
                    
                    // 2초 후 대문으로 이동
                    setTimeout(() => {
                        window.location.replace('/');
                    }, 2000);
                    } else {
                    showStatusMessage(result.message, 'error');
                    }
                } catch (error) {
                console.error('게스트 등록 실패:', error);
                showStatusMessage('게스트 등록에 실패했습니다.', 'error');
            }
        });

        // 실제 사용자 등록 처리
        document.getElementById('user-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userData = {
                name: document.getElementById('user-name').value,
                phone: document.getElementById('user-phone').value,
                exam_date: document.getElementById('user-exam-date').value
            };

            try {
                const response = await fetch('/api/register/user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // LocalStorage에 사용자 정보 저장
                    localStorage.setItem('aicu_user_data', JSON.stringify(result.user_data));
                    
                    // 등록 완료 플래그 설정 (홈페이지 접근 제어용)
                    const registrationData = {
                        type: 'registered',
                        registration_timestamp: result.user_data.created_at,
                        is_permanent: true,
                        user_name: result.user_data.name,
                        registration_date: result.user_data.registration_date.split('T')[0]
                    };
                    localStorage.setItem('aicu_registration_completed', JSON.stringify(registrationData));
                    localStorage.setItem('aicu_registration_timestamp', result.user_data.created_at);
                    
                    // 등록 시점 기반 통계 초기화
                    initializeUserStatistics(result.user_data);
                    
                    showStatusMessage('사용자 등록이 완료되었습니다!', 'success');
                    
                    // 2초 후 대문으로 이동
                    setTimeout(() => {
                        window.location.replace('/');
                    }, 2000);
                } else {
                    showStatusMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('사용자 등록 실패:', error);
                showStatusMessage('사용자 등록에 실패했습니다.', 'error');
            }
        });
    </script>
</body>
</html>