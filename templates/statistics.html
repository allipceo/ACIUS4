<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACIU S4 - 통계</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/incorrect_analysis.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 헤더 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">📊 학습 통계</h1>
            <p class="text-gray-600">학습 성과 및 진행 상황</p>
        </div>

        <!-- 사용자 정보 -->
        <div id="user-info" class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">👤 현재 사용자</h2>
            <div id="user-details" class="space-y-2">
                <!-- 사용자 정보가 여기에 동적으로 표시됩니다 -->
            </div>
        </div>

        <!-- 통계 카드들 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- 총 문제 수 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-600 mb-2" id="total-questions">0</div>
                    <div class="text-gray-600">총 문제 수</div>
                </div>
            </div>

            <!-- 풀이한 문제 수 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-600 mb-2" id="solved-questions">0</div>
                    <div class="text-gray-600">풀이한 문제</div>
                </div>
            </div>

            <!-- 정답률 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-purple-600 mb-2" id="accuracy-rate">0%</div>
                    <div class="text-gray-600">정답률</div>
                </div>
            </div>

            <!-- 학습 시간 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-orange-600 mb-2" id="study-time">0분</div>
                    <div class="text-gray-600">총 학습 시간</div>
                </div>
            </div>
        </div>

        <!-- 상세 통계 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- 카테고리별 성과 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">📈 카테고리별 성과</h3>
                <div id="category-stats" class="space-y-3">
                    <!-- 카테고리별 통계가 여기에 동적으로 표시됩니다 -->
                </div>
            </div>

            <!-- 최근 학습 기록 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">📝 최근 학습 기록</h3>
                <div id="recent-activity" class="space-y-3">
                    <!-- 최근 활동이 여기에 동적으로 표시됩니다 -->
                </div>
            </div>
        </div>

        <!-- 오답 분석 섹션 -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">🔍 오답 분석 및 개인 맞춤 인사이트</h2>
            
            <!-- 오답 분석 요약 -->
            <div id="incorrect-summary-container" class="mb-6">
                <!-- 오답 분석 요약이 여기에 표시됩니다 -->
            </div>
            
            <!-- 위험도별 문제 목록 -->
            <div id="critical-questions-container" class="mb-6">
                <!-- 위험도별 문제 목록이 여기에 표시됩니다 -->
            </div>
            
            <!-- 과목별 분석 -->
            <div id="subject-analysis-container" class="mb-6">
                <!-- 과목별 분석이 여기에 표시됩니다 -->
            </div>
            
            <!-- 개인 맞춤 인사이트 -->
            <div id="insights-container" class="mb-6">
                <!-- 개인 맞춤 인사이트가 여기에 표시됩니다 -->
            </div>
            
            <!-- 학습 권장사항 -->
            <div id="recommendations-container" class="mb-6">
                <!-- 학습 권장사항이 여기에 표시됩니다 -->
            </div>
        </div>

        <!-- 액션 버튼들 -->
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">🚀 액션</h3>
            <div class="space-y-3">
                <button onclick="startNewSession()" 
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                    새로운 학습 세션 시작
                </button>
                <button onclick="resetStatistics()" 
                        class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                    통계 초기화
                </button>
                <a href="/home" 
                   class="block w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors text-center">
                    대문으로 돌아가기
                </a>
            </div>
        </div>
    </div>

    <script>
        // 페이지 로드 시 통계 표시
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== 통계 페이지 로드 ===');
            checkUserAndLoadStatistics();
        });

        // 사용자 확인 및 통계 로드
        function checkUserAndLoadStatistics() {
            try {
                const userData = localStorage.getItem('aicu_user_data');
                
                if (userData) {
                    const user = JSON.parse(userData);
                    displayUserInfo(user);
                    loadStatistics();
                } else {
                    console.log('❌ 사용자 정보 없음');
                    alert('사용자 정보가 없습니다. 먼저 등록해주세요.');
                    window.location.href = '/register';
                }
                
            } catch (error) {
                console.error('❌ 사용자 확인 실패:', error);
                alert('사용자 정보를 확인할 수 없습니다.');
                window.location.href = '/register';
            }
        }

        // 사용자 정보 표시
        function displayUserInfo(user) {
            const userDetailsElement = document.getElementById('user-details');
            
            // D-Day 계산
            const examDate = new Date(user.exam_date);
            const today = new Date();
            const timeDiff = examDate.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            const dDayText = daysDiff > 0 ? `D-${daysDiff}` : `D+${Math.abs(daysDiff)}`;
            
            userDetailsElement.innerHTML = `
                <div class="flex justify-between">
                    <span class="font-medium">이름:</span>
                    <span>${user.name}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">유형:</span>
                    <span class="${user.user_type === 'guest' ? 'text-blue-600' : 'text-green-600'}">
                        ${user.user_type === 'guest' ? '게스트' : '실제 사용자'}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">D-Day:</span>
                    <span class="font-bold ${daysDiff <= 30 ? 'text-red-600' : 'text-blue-600'}">${dDayText}</span>
                </div>
            `;
        }

        // 통계 데이터 로드
        function loadStatistics() {
            try {
                // LocalStorage에서 통계 데이터 로드
                const statsData = localStorage.getItem('aicu_statistics') || '{}';
                const stats = JSON.parse(statsData);
                
                // 기본값 설정
                const defaultStats = {
                    totalQuestions: 0,
                    solvedQuestions: 0,
                    correctAnswers: 0,
                    studyTime: 0,
                    categories: {},
                    recentActivity: []
                };
                
                const finalStats = { ...defaultStats, ...stats };
                
                // 통계 표시
                displayStatistics(finalStats);
                
            } catch (error) {
                console.error('❌ 통계 로드 실패:', error);
                displayStatistics({
                    totalQuestions: 0,
                    solvedQuestions: 0,
                    correctAnswers: 0,
                    studyTime: 0,
                    categories: {},
                    recentActivity: []
                });
            }
        }

        // 통계 표시
        function displayStatistics(stats) {
            // 기본 통계 표시
            document.getElementById('total-questions').textContent = stats.totalQuestions;
            document.getElementById('solved-questions').textContent = stats.solvedQuestions;
            
            const accuracyRate = stats.solvedQuestions > 0 
                ? Math.round((stats.correctAnswers / stats.solvedQuestions) * 100) 
                : 0;
            document.getElementById('accuracy-rate').textContent = `${accuracyRate}%`;
            
            document.getElementById('study-time').textContent = `${stats.studyTime}분`;
            
            // 카테고리별 통계 표시
            displayCategoryStats(stats.categories);
            
            // 최근 활동 표시
            displayRecentActivity(stats.recentActivity);
        }

        // 카테고리별 통계 표시
        function displayCategoryStats(categories) {
            const categoryStatsElement = document.getElementById('category-stats');
            
            if (Object.keys(categories).length === 0) {
                categoryStatsElement.innerHTML = '<p class="text-gray-500">아직 카테고리별 데이터가 없습니다.</p>';
                return;
            }
            
            let html = '';
            for (const [category, data] of Object.entries(categories)) {
                const accuracy = data.solved > 0 ? Math.round((data.correct / data.solved) * 100) : 0;
                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-medium">${category}</div>
                            <div class="text-sm text-gray-600">${data.solved}문제 풀이</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-blue-600">${accuracy}%</div>
                            <div class="text-sm text-gray-600">정답률</div>
                        </div>
                    </div>
                `;
            }
            
            categoryStatsElement.innerHTML = html;
        }

        // 최근 활동 표시
        function displayRecentActivity(activities) {
            const recentActivityElement = document.getElementById('recent-activity');
            
            if (activities.length === 0) {
                recentActivityElement.innerHTML = '<p class="text-gray-500">아직 학습 기록이 없습니다.</p>';
                return;
            }
            
            let html = '';
            activities.slice(0, 5).forEach(activity => {
                const date = new Date(activity.timestamp).toLocaleDateString('ko-KR');
                const time = new Date(activity.timestamp).toLocaleTimeString('ko-KR');
                
                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-medium">${activity.action}</div>
                            <div class="text-sm text-gray-600">${date} ${time}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-green-600">${activity.result}</div>
                        </div>
                    </div>
                `;
            });
            
            recentActivityElement.innerHTML = html;
        }

        // 새로운 학습 세션 시작
        function startNewSession() {
            // 기본 학습 페이지로 이동
            window.location.href = '/basic-learning';
        }

        // 통계 초기화
        function resetStatistics() {
            if (confirm('정말로 모든 통계 데이터를 초기화하시겠습니까?')) {
                try {
                    // LocalStorage에서 통계 데이터 삭제
                    localStorage.removeItem('aicu_statistics');
                    
                    // 페이지 새로고침
                    location.reload();
                    
                } catch (error) {
                    console.error('통계 초기화 실패:', error);
                    alert('통계 초기화에 실패했습니다.');
                }
            }
        }
    </script>
    
    <!-- Week3 오답 분석 스크립트 -->
    <script src="/static/js/incorrect_analysis.js"></script>
</body>
</html>
