<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACIU S4 - 설정</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 헤더 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">⚙️ 사용자 설정</h1>
            <p class="text-gray-600">사용자 정보 및 시스템 설정</p>
        </div>

        <!-- 현재 사용자 정보 -->
        <div id="current-user-info" class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">👤 현재 사용자 정보</h2>
            <div id="user-details" class="space-y-3">
                <!-- 사용자 정보가 여기에 동적으로 표시됩니다 -->
            </div>
        </div>

        <!-- 설정 옵션들 -->
        <div class="max-w-2xl mx-auto space-y-6">
            <!-- 사용자 정보 수정 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">✏️ 사용자 정보 수정</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">이름</label>
                        <input type="text" id="edit-name" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">전화번호</label>
                        <input type="tel" id="edit-phone" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">시험일자</label>
                        <input type="date" id="edit-exam-date" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button onclick="updateUserInfo()" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        정보 수정
                    </button>
                </div>
            </div>

            <!-- 학습 설정 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">📚 학습 설정</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">일일 목표 문제수</label>
                        <select id="daily-goal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="10">10문제</option>
                            <option value="20">20문제</option>
                            <option value="30">30문제</option>
                            <option value="50" selected>50문제 (권장)</option>
                            <option value="100">100문제</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">선호 학습시간</label>
                        <select id="study-time" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="morning">오전 (09:00-12:00)</option>
                            <option value="afternoon" selected>오후 (13:00-18:00)</option>
                            <option value="evening">저녁 (19:00-22:00)</option>
                            <option value="night">밤 (22:00-01:00)</option>
                        </select>
                    </div>
                    <button onclick="updateLearningSettings()" 
                            class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                        학습 설정 저장
                    </button>
                </div>
            </div>

            <!-- 데이터 관리 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">🗂️ 데이터 관리</h3>
                <div class="space-y-4">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-yellow-800 text-sm">
                            <strong>주의:</strong> 데이터 초기화는 되돌릴 수 없습니다. 신중히 선택해 주세요.
                        </p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="resetStatistics()" 
                                class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                            📊 통계 데이터 초기화
                        </button>
                        <button onclick="resetAllData()" 
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                            🗑️ 모든 데이터 초기화
                        </button>
                    </div>
                </div>
            </div>

            <!-- 시스템 정보 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">ℹ️ 시스템 정보</h3>
                <div class="space-y-2 text-sm text-gray-600">
                    <div class="flex justify-between">
                        <span>시스템 버전:</span>
                        <span>AICU S4 v3.6</span>
                    </div>
                    <div class="flex justify-between">
                        <span>사용자 등록 방식:</span>
                        <span>LocalStorage 기반</span>
                    </div>
                    <div class="flex justify-between">
                        <span>데이터 저장 위치:</span>
                        <span>브라우저 로컬</span>
                    </div>
                    <div class="flex justify-between">
                        <span>등록 상태:</span>
                        <span id="registration-status" class="font-medium">확인 중...</span>
                    </div>
                </div>
            </div>

            <!-- 액션 버튼들 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <a href="/home" 
                       class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors text-center">
                        🏠 대문으로 돌아가기
                    </a>
                    <button onclick="exportUserData()" 
                            class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                        📤 사용자 데이터 내보내기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 페이지 로드 시 사용자 정보 표시
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== 설정 페이지 로드 ===');
            loadUserInfo();
            loadLearningSettings();
        });

        // 사용자 정보 로드 및 표시
        function loadUserInfo() {
            try {
                const userData = localStorage.getItem('aicu_user_data');
                
                if (userData) {
                    const user = JSON.parse(userData);
                    displayUserInfo(user);
                    populateEditForm(user);
                    document.getElementById('registration-status').textContent = '등록됨';
                    document.getElementById('registration-status').className = 'font-medium text-green-600';
                } else {
                    console.log('❌ 사용자 정보 없음');
                    document.getElementById('registration-status').textContent = '미등록';
                    document.getElementById('registration-status').className = 'font-medium text-red-600';
                    alert('사용자 정보가 없습니다. 먼저 등록해주세요.');
                    window.location.href = '/register';
                }
                
            } catch (error) {
                console.error('❌ 사용자 정보 로드 실패:', error);
                alert('사용자 정보를 불러올 수 없습니다.');
                window.location.href = '/register';
            }
        }

        // 사용자 정보 표시
        function displayUserInfo(user) {
            const userDetailsElement = document.getElementById('user-details');
            
            // D-Day 계산
            const examDate = new Date(user.exam_date);
            const today = new Date();
            const timeDiff = examDate.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            const dDayText = daysDiff > 0 ? `D-${daysDiff}` : `D+${Math.abs(daysDiff)}`;
            
            userDetailsElement.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="font-medium">이름:</span>
                            <span>${user.name}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">유형:</span>
                            <span class="${user.user_type === 'guest' ? 'text-blue-600' : 'text-green-600'} font-medium">
                                ${user.user_type === 'guest' ? '게스트' : '실제 사용자'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">전화번호:</span>
                            <span>${user.phone || '미입력'}</span>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="font-medium">시험:</span>
                            <span>${user.exam_subject}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">시험일:</span>
                            <span>${user.exam_date}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">D-Day:</span>
                            <span class="font-bold ${daysDiff <= 30 ? 'text-red-600' : 'text-blue-600'}">${dDayText}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">등록일:</span>
                            <span>${user.registration_date}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // 수정 폼에 사용자 정보 채우기
        function populateEditForm(user) {
            document.getElementById('edit-name').value = user.name;
            document.getElementById('edit-phone').value = user.phone || '';
            document.getElementById('edit-exam-date').value = user.exam_date;
        }

        // 사용자 정보 수정
        async function updateUserInfo() {
            try {
                const userData = localStorage.getItem('aicu_user_data');
                if (!userData) {
                    alert('사용자 정보가 없습니다.');
                    return;
                }

                const user = JSON.parse(userData);
                const newName = document.getElementById('edit-name').value.trim();
                const newPhone = document.getElementById('edit-phone').value.trim();
                const newExamDate = document.getElementById('edit-exam-date').value;

                // 입력값 검증
                if (!newName || newName.length < 2) {
                    alert('이름을 2글자 이상 입력해주세요.');
                    return;
                }

                if (!newExamDate) {
                    alert('시험일자를 입력해주세요.');
                    return;
                }

                // 사용자 정보 업데이트
                const updatedUser = {
                    ...user,
                    name: newName,
                    phone: newPhone,
                    exam_date: newExamDate,
                    updated_at: new Date().toISOString()
                };

                // LocalStorage에 저장
                localStorage.setItem('aicu_user_data', JSON.stringify(updatedUser));

                // 화면 업데이트
                displayUserInfo(updatedUser);

                alert('사용자 정보가 수정되었습니다.');
                console.log('✅ 사용자 정보 수정 완료:', updatedUser);

            } catch (error) {
                console.error('❌ 사용자 정보 수정 실패:', error);
                alert('사용자 정보 수정에 실패했습니다.');
            }
        }

        // 학습 설정 로드
        function loadLearningSettings() {
            try {
                const settingsData = localStorage.getItem('aicu_learning_settings');
                if (settingsData) {
                    const settings = JSON.parse(settingsData);
                    document.getElementById('daily-goal').value = settings.dailyGoal || '50';
                    document.getElementById('study-time').value = settings.studyTime || 'afternoon';
                }
            } catch (error) {
                console.error('❌ 학습 설정 로드 실패:', error);
            }
        }

        // 학습 설정 저장
        function updateLearningSettings() {
            try {
                const dailyGoal = document.getElementById('daily-goal').value;
                const studyTime = document.getElementById('study-time').value;

                const settings = {
                    dailyGoal: dailyGoal,
                    studyTime: studyTime,
                    updated_at: new Date().toISOString()
                };

                localStorage.setItem('aicu_learning_settings', JSON.stringify(settings));
                alert('학습 설정이 저장되었습니다.');
                console.log('✅ 학습 설정 저장 완료:', settings);

            } catch (error) {
                console.error('❌ 학습 설정 저장 실패:', error);
                alert('학습 설정 저장에 실패했습니다.');
            }
        }

        // 통계 데이터 초기화
        function resetStatistics() {
            if (confirm('정말로 모든 통계 데이터를 초기화하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
                try {
                    localStorage.removeItem('aicu_statistics');
                    localStorage.removeItem('aicu_quiz_progress');
                    localStorage.removeItem('aicu_learning_history');
                    alert('통계 데이터가 초기화되었습니다.');
                    console.log('✅ 통계 데이터 초기화 완료');
                } catch (error) {
                    console.error('❌ 통계 데이터 초기화 실패:', error);
                    alert('통계 데이터 초기화에 실패했습니다.');
                }
            }
        }

        // 모든 데이터 초기화
        function resetAllData() {
            if (confirm('정말로 모든 데이터를 초기화하시겠습니까?\n\n이 작업은 되돌릴 수 없으며, 사용자 정보도 함께 삭제됩니다.')) {
                try {
                    // 모든 AICU 관련 데이터 삭제
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('aicu_')) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    
                    alert('모든 데이터가 초기화되었습니다. 다시 등록해주세요.');
                    console.log('✅ 모든 데이터 초기화 완료');
                    
                    // 등록 페이지로 이동
                    window.location.href = '/register';
                    
                } catch (error) {
                    console.error('❌ 모든 데이터 초기화 실패:', error);
                    alert('데이터 초기화에 실패했습니다.');
                }
            }
        }

        // 사용자 데이터 내보내기
        function exportUserData() {
            try {
                const userData = localStorage.getItem('aicu_user_data');
                const statisticsData = localStorage.getItem('aicu_statistics');
                const learningSettings = localStorage.getItem('aicu_learning_settings');
                
                const exportData = {
                    user: userData ? JSON.parse(userData) : null,
                    statistics: statisticsData ? JSON.parse(statisticsData) : null,
                    learningSettings: learningSettings ? JSON.parse(learningSettings) : null,
                    exportDate: new Date().toISOString()
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `aicu_user_data_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                alert('사용자 데이터가 다운로드되었습니다.');
                console.log('✅ 사용자 데이터 내보내기 완료');
                
            } catch (error) {
                console.error('❌ 사용자 데이터 내보내기 실패:', error);
                alert('데이터 내보내기에 실패했습니다.');
            }
        }
    </script>
</body>
</html>
