# GEP V1.0 이벤트 데이터 흐름도 시나리오

## 1. 시스템 개요

### 1.1 핵심 시나리오
- **사용자 등록**: 게스트/등록 사용자 구분
- **문제풀이**: 과목별 연속 학습
- **통계 제공**: 금일/누적 통계 실시간 업데이트
- **오답 분석**: 틀린 문제 패턴 분석

### 1.2 데이터 흐름 원칙
- **실시간 기록**: 모든 사용자 액션 즉시 EVENT_DB 저장
- **중앙아키텍처**: CentralDataManager를 통한 일관된 데이터 관리
- **LocalStorage 동기화**: 오프라인 지원 및 성능 최적화

## 2. 시나리오별 데이터 흐름도

### 2.1 사용자 등록 시나리오

#### 시나리오: 조대표님의 첫 등록
```
사용자 액션: "보험중개사 시험 준비, 2025년 9월 13일 시험"
```

#### 데이터 흐름
```
1. 사용자 입력 → 2. 중앙아키텍처 → 3. EVENT_DB 기록 → 4. LocalStorage 동기화
```

#### EVENT_DB 필드 데이터
```json
{
  "EVENT_ID": "EVT_20241219_001",
  "USER_ID": "user_001",
  "USER_TYPE": "registered",
  "EVENT_TYPE": "registration",
  "TIMESTAMP": "2024-12-19 14:30:25",
  "SESSION_ID": "SESS_20241219_143025",
  
  "REGISTRATION_DATE": "2024-12-19",
  "EXAM_DATE": "2025-09-13",
  "USER_NAME": "조대표",
  "INITIAL_SETTINGS": {
    "theme": "light",
    "sound": "on",
    "auto_save": "enabled"
  }
}
```

#### 프로세스 상세
1. **사용자 입력**: 이름, 시험일, 설정 선택
2. **중앙아키텍처**: CentralDataManager.recordRegistration()
3. **EVENT_DB 기록**: 등록 이벤트 저장
4. **LocalStorage 동기화**: 사용자 정보 로컬 저장

### 2.2 문제풀이 시나리오

#### 시나리오: DAY 1 학습 (10:00, 13:00, 17:00)
```
10:00 - 관계법령 1-10번 문제 풀이
13:00 - 관계법령 11-40번 문제 풀이
17:00 - 41번째 문제 표시, 금일 통계 확인
```

#### 데이터 흐름
```
문제 표시 → 답안 선택 → 정답 확인 → 이벤트 기록 → 통계 업데이트
```

#### EVENT_DB 필드 데이터 (10:00 첫 문제)
```json
{
  "EVENT_ID": "EVT_20241219_002",
  "USER_ID": "user_001",
  "USER_TYPE": "registered",
  "EVENT_TYPE": "question_solve",
  "TIMESTAMP": "2024-12-19 10:00:15",
  "SESSION_ID": "SESS_20241219_100000",
  
  "QCODE": "ABAA-01",
  "ETITLE": "보험중개사",
  "ECLASS": "손해보험",
  "LAYER1": "관계법령",
  "EROUND": 20,
  "QNUM": 1,
  "USER_ANSWER": "2",
  "CORRECT_ANSWER": "2",
  "IS_CORRECT": true,
  "SOLVE_TIME": 45,
  "DIFFICULTY_RATING": 3
}
```

#### EVENT_DB 필드 데이터 (13:00 30번째 문제)
```json
{
  "EVENT_ID": "EVT_20241219_031",
  "USER_ID": "user_001",
  "USER_TYPE": "registered",
  "EVENT_TYPE": "question_solve",
  "TIMESTAMP": "2024-12-19 13:15:30",
  "SESSION_ID": "SESS_20241219_130000",
  
  "QCODE": "ABAA-30",
  "ETITLE": "보험중개사",
  "ECLASS": "손해보험",
  "LAYER1": "관계법령",
  "EROUND": 20,
  "QNUM": 30,
  "USER_ANSWER": "1",
  "CORRECT_ANSWER": "3",
  "IS_CORRECT": false,
  "SOLVE_TIME": 120,
  "DIFFICULTY_RATING": 4
}
```

#### 프로세스 상세
1. **문제 표시**: 41번째 문제 로드
2. **답안 선택**: 사용자가 답안 클릭
3. **정답 확인**: 시스템이 정답 여부 판단
4. **이벤트 기록**: CentralDataManager.recordQuestionSolve()
5. **통계 업데이트**: 실시간 정답률 계산

### 2.3 통계 확인 시나리오

#### 시나리오: 17:00 통계 페이지 방문
```
사용자: "오늘 얼마나 공부했지?"
시스템: "오늘 40문제 풀이, 정답률 80%"
```

#### 데이터 흐름
```
통계 요청 → 이벤트 조회 → 통계 계산 → 결과 표시 → 통계 이벤트 기록
```

#### EVENT_DB 필드 데이터 (금일 통계)
```json
{
  "EVENT_ID": "EVT_20241219_041",
  "USER_ID": "user_001",
  "USER_TYPE": "registered",
  "EVENT_TYPE": "statistics_view",
  "TIMESTAMP": "2024-12-19 17:00:00",
  "SESSION_ID": "SESS_20241219_170000",
  
  "STATS_TYPE": "daily",
  "SUBJECT": "관계법령",
  "TOTAL_QUESTIONS": 40,
  "CORRECT_COUNT": 32,
  "INCORRECT_COUNT": 8,
  "ACCURACY_RATE": 80.00,
  "STUDY_TIME": 180
}
```

#### EVENT_DB 필드 데이터 (누적 통계)
```json
{
  "EVENT_ID": "EVT_20241219_042",
  "USER_ID": "user_001",
  "USER_TYPE": "registered",
  "EVENT_TYPE": "statistics_view",
  "TIMESTAMP": "2024-12-19 17:01:00",
  "SESSION_ID": "SESS_20241219_170000",
  
  "STATS_TYPE": "cumulative",
  "SUBJECT": "관계법령",
  "TOTAL_QUESTIONS": 40,
  "CORRECT_COUNT": 32,
  "INCORRECT_COUNT": 8,
  "ACCURACY_RATE": 80.00,
  "STUDY_TIME": 180
}
```

#### 프로세스 상세
1. **통계 요청**: 사용자가 통계 페이지 접근
2. **이벤트 조회**: 해당 날짜의 문제풀이 이벤트 조회
3. **통계 계산**: 정답률, 학습시간 등 계산
4. **결과 표시**: UI에 통계 정보 표시
5. **통계 이벤트 기록**: 통계 확인 이벤트 저장

### 2.4 오답 분석 시나리오

#### 시나리오: 자주 틀린 문제 확인
```
사용자: "어떤 문제를 자주 틀렸지?"
시스템: "5번 틀린 문제: 3개, 4번 틀린 문제: 5개"
```

#### 데이터 흐름
```
오답 분석 요청 → 오답 이벤트 조회 → 패턴 분석 → 결과 표시
```

#### EVENT_DB 필드 데이터 (오답 분석)
```json
{
  "EVENT_ID": "EVT_20241219_043",
  "USER_ID": "user_001",
  "USER_TYPE": "registered",
  "EVENT_TYPE": "error_analysis",
  "TIMESTAMP": "2024-12-19 17:02:00",
  "SESSION_ID": "SESS_20241219_170000",
  
  "ERROR_COUNT": 3,
  "ERROR_PATTERN": {
    "ABAA-15": 5,
    "ABAA-22": 4,
    "ABAA-30": 4,
    "ABAA-35": 3
  },
  "LAST_ERROR_DATE": "2024-12-19",
  "DIFFICULTY_LEVEL": "high"
}
```

#### 프로세스 상세
1. **오답 분석 요청**: 사용자가 오답 분석 페이지 접근
2. **오답 이벤트 조회**: IS_CORRECT = false인 이벤트 조회
3. **패턴 분석**: QCODE별 틀린 횟수 집계
4. **결과 표시**: 5번/4번/3번 틀린 문제 목록 표시

## 3. 중앙아키텍처 연동 상세

### 3.1 CentralDataManager 구조

```javascript
class CentralDataManager {
    constructor() {
        this.eventDB = new EventDBManager();
        this.statisticsManager = new StatisticsManager();
        this.localStorageManager = new LocalStorageManager();
    }
    
    // 문제풀이 기록
    recordQuestionSolve(qcode, userAnswer, isCorrect, solveTime) {
        const eventData = {
            EVENT_ID: this.generateEventId(),
            USER_ID: this.getCurrentUserId(),
            USER_TYPE: this.getCurrentUserType(),
            EVENT_TYPE: 'question_solve',
            TIMESTAMP: new Date().toISOString(),
            SESSION_ID: this.getCurrentSessionId(),
            
            QCODE: qcode,
            ETITLE: this.getQuestionInfo(qcode).etitle,
            ECLASS: this.getQuestionInfo(qcode).eclass,
            LAYER1: this.getQuestionInfo(qcode).layer1,
            EROUND: this.getQuestionInfo(qcode).eround,
            QNUM: this.getQuestionInfo(qcode).qnum,
            USER_ANSWER: userAnswer,
            CORRECT_ANSWER: this.getCorrectAnswer(qcode),
            IS_CORRECT: isCorrect,
            SOLVE_TIME: solveTime,
            DIFFICULTY_RATING: this.getDifficultyRating(qcode)
        };
        
        // EVENT_DB에 저장
        this.eventDB.saveEvent(eventData);
        
        // 통계 업데이트
        this.statisticsManager.updateStatistics(eventData);
        
        // LocalStorage 동기화
        this.localStorageManager.syncEvent(eventData);
        
        return eventData;
    }
    
    // 통계 조회
    getStatistics(statsType, subject) {
        const events = this.eventDB.getEventsByType('question_solve');
        
        if (statsType === 'daily') {
            return this.statisticsManager.calculateDailyStats(events);
        } else if (statsType === 'cumulative') {
            return this.statisticsManager.calculateCumulativeStats(events);
        }
    }
}
```

### 3.2 실시간 데이터 동기화

```javascript
class EventDBManager {
    // 이벤트 저장
    saveEvent(eventData) {
        // 1. 메모리 캐시 업데이트
        this.updateMemoryCache(eventData);
        
        // 2. LocalStorage 저장
        this.saveToLocalStorage(eventData);
        
        // 3. 서버 동기화 (온라인 시)
        if (navigator.onLine) {
            this.syncToServer(eventData);
        }
    }
    
    // 이벤트 조회
    getEventsByType(eventType) {
        // 1. 메모리 캐시에서 조회
        let events = this.getFromMemoryCache(eventType);
        
        // 2. LocalStorage에서 조회 (캐시 미스 시)
        if (!events.length) {
            events = this.getFromLocalStorage(eventType);
        }
        
        return events;
    }
}
```

## 4. 성능 최적화 전략

### 4.1 인덱싱 전략
```sql
-- 주요 조회 패턴별 인덱스
CREATE INDEX idx_user_date ON EVENT_DB(USER_ID, DATE(TIMESTAMP));
CREATE INDEX idx_event_type_date ON EVENT_DB(EVENT_TYPE, DATE(TIMESTAMP));
CREATE INDEX idx_qcode_user ON EVENT_DB(QCODE, USER_ID);
CREATE INDEX idx_correct_user ON EVENT_DB(IS_CORRECT, USER_ID);
```

### 4.2 캐싱 전략
```javascript
class CacheManager {
    constructor() {
        this.memoryCache = new Map();
        this.cacheExpiry = 5 * 60 * 1000; // 5분
    }
    
    // 메모리 캐시 업데이트
    updateCache(key, data) {
        this.memoryCache.set(key, {
            data: data,
            timestamp: Date.now()
        });
    }
    
    // 캐시에서 조회
    getFromCache(key) {
        const cached = this.memoryCache.get(key);
        if (cached && Date.now() - cached.timestamp < this.cacheExpiry) {
            return cached.data;
        }
        return null;
    }
}
```

## 5. 오류 처리 및 복구

### 5.1 네트워크 오류 처리
```javascript
class ErrorHandler {
    handleNetworkError(eventData) {
        // 1. LocalStorage에 임시 저장
        this.saveToPendingQueue(eventData);
        
        // 2. 네트워크 복구 시 재전송
        window.addEventListener('online', () => {
            this.processPendingQueue();
        });
    }
    
    // 데이터 무결성 검증
    validateEventData(eventData) {
        const requiredFields = ['EVENT_ID', 'USER_ID', 'EVENT_TYPE', 'TIMESTAMP'];
        return requiredFields.every(field => eventData[field]);
    }
}
```

## 6. 시나리오별 데이터 검증

### 6.1 등록 시나리오 검증
- **필수 필드**: USER_ID, EVENT_TYPE, TIMESTAMP
- **데이터 검증**: 시험일이 미래 날짜인지 확인
- **중복 방지**: 동일 사용자의 중복 등록 방지

### 6.2 문제풀이 시나리오 검증
- **필수 필드**: QCODE, USER_ANSWER, IS_CORRECT
- **데이터 검증**: QCODE가 유효한 문제 코드인지 확인
- **시간 검증**: SOLVE_TIME이 합리적인 범위인지 확인

### 6.3 통계 시나리오 검증
- **데이터 일관성**: 총 문제수 = 정답수 + 오답수
- **정답률 검증**: 0% ≤ 정답률 ≤ 100%
- **시간 검증**: STUDY_TIME이 합리적인 범위인지 확인

---

**작성자**: AI Assistant (Seo Daeri)  
**작성일**: 2024-12-19  
**버전**: GEP V1.0 Event Data Flow v1.0
